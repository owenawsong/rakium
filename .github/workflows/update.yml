name: Update Rakium Data

# ── When to run ──────────────────────────────────────────────────
on:
  schedule:
    # Every 6 hours: midnight, 6am, noon, 6pm UTC
    - cron: "0 */6 * * *"

  # Also run when you push code (so the site builds immediately on first deploy)
  push:
    branches: [main]

  # Allow manual trigger from GitHub UI
  workflow_dispatch:

# ── Permissions ──────────────────────────────────────────────────
permissions:
  contents: write          # needed to commit updated data back to repo

# ── Jobs ─────────────────────────────────────────────────────────
jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # 1. Check out the repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3. Install dependencies
      - name: Install dependencies
        run: pip install -r requirements.txt

      # 4. Run the scraper
      - name: Scrape data
        run: python scripts/scraper.py

      # 5. Generate the HTML
      - name: Generate HTML
        run: python scripts/generator.py

      # 6. Commit updated data + HTML back to the repo
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/ output/
          git diff --staged --quiet || git commit -m "Auto-update: $(date -u '+%Y-%m-%d %H:%M UTC')"
          git push